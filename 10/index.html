<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta property="og:title" content="LINE風チャットアプリ" />
  <meta property="og:type" content="chat" />
  <meta property="og:description" content="BaaS（Milkcocoa）で作られたリアルタイムチャット" />
  <title>LINE風チャットアプリ</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" />
  <link rel="stylesheet" href="style.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="http://cdn.mlkcca.com/v2.0.0/milkcocoa.js"></script>
  <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
</head>

<body>
  <header>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <span class="navbar-brand">LINE風チャットアプリ</span>
        </div>
        <a id="sort" class="btn btn-default navbar-btn header-btn pull-right">並べ替え</a>
      </div>
    </nav>
  </header>
  <main>
    <div class="container">
      <div id="messages" class="content">
      </div>
      <div id="postarea">
        <input type="text" name="name" placeholder="名前">
        <input type="email" name="email" placeholder="メールアドレス">
        <div class="postarea-text">
          <textarea name="" id="content" cols="30" rows="10" placeholder="Enterで投稿"></textarea>
        </div>
        <button id="post" class="postarea-button">送信</button>
        <button id="delete" class="postarea-button">全て削除</button>
      </div>
    </div>
  </main>
  <footer>
    <div class="container">
      <p class="footer">Powered by <a href="http://mlkcca.com/">Milkcocoa</a></p>
    </div>
  </footer>

  <script>
  var translator_app_id = encodeURIComponent('v38ZMz/FKfPBmfeZ7hyxOXe7k+EWCBK3kT0YBFlfwcY');
  var language = 'ja';
  var last_message;
  var sort = 'asc';
  $(function() {
    // 言語選択ボタン作成
    setLanguageButton();
    // ミルクココアインスタンスを作成
    var milkcocoa = new MilkCocoa("teaifc51u4b.mlkcca.com");
    // "message"データストアを作成
    var ds = milkcocoa.dataStore("message");
    // "message"データストアからメッセージを取ってくる
    ds.stream().sort("desc").next(function(err, datas) {
      datas.forEach(function(data) {
        renderMessage(data);
      });
    });
    // "message"データストアのプッシュイベントを監視
    ds.on("push", function(e) {
      renderMessage(e);
    });
    // "message"データストアのリムーブイベントを監視
    ds.on("remove", function(e) {
      deleteElement(e.id);
    });
    // "message"データストアにメッセージをプッシュする
    $('#post').on('click', function () {
      post(ds);
    });
    $('#content').on('keydown', function (e) {
      if (e.which == 13){
        post(ds);
        return false;
      }
    });
    // 後から追加した要素にもイベント適用させるため親要素に設定
    $('#messages').on('click', '.delete-btn', function(){
      var id = $(this).attr('id');
      id = id.substring('delete'.length, id.length);
      deleteMessage(ds, id);
    });
    $('#delete').on('click', function(){
      deleteAllMessages(ds);
    });
    // 並び順の変更
    $('#sort').on('click', function(){
      // 操作用のDocumentFragment作成
      var fragment = document.createDocumentFragment();
      var messages = document.getElementById('messages');
      var base = document.getElementById(last_message);
      var postarea = document.getElementById('postarea');
      // messagesをfragmentに移動
      fragment.appendChild(messages);
      // フラグ反転
      sort = sort == 'asc' ? 'desc' : 'asc';
      // 昇順
      if (sort == 'asc') {
        var next;
        // baseのhrタグ位置変更
        base.insertBefore(base.lastChild, base.firstChild);
        // 並べ替え
        while (messages.lastChild.id != last_message) {
          next = base.nextSibling;
          // hrタグ位置変更
          next.insertBefore(next.lastChild, next.firstChild);
          // nextを先頭に移動
          messages.insertBefore(next, messages.firstChild);
        }
        // postarea.prepend(messages)
        postarea.parentNode.insertBefore(messages, postarea);
        $('#messages').scrollTop($('#messages').get(0).scrollHeight);
      // 降順
      } else {
        var prev;
        // baseのhrタグ位置変更
        base.appendChild(base.firstChild);
        // 並べ替え
        while (messages.firstChild.id != last_message) {
          prev = base.previousSibling;
          // hrタグ位置変更
          prev.appendChild(prev.firstChild);
          // prevを最後に移動
          messages.appendChild(prev);
        }
        // postarea.append(messages)
        postarea.parentNode.appendChild(messages);
      }
    });
    // 使用言語変更
    $('select[name=language]').on('change', function(){
      language = $(this).children('option:selected').val();
    });
  });

  function setLanguageButton() {
    var language_set = [
      {value: 'ar', text: 'العربية'}, // Arabic
      {value: 'bs-Latn', text: 'bosanski'}, // Bosnian (Latin)
      {value: 'bg', text: 'български'}, // Bulgaria
      {value: 'ca', text: 'Català'}, // Catalan
      {value: 'zh-CHS', text: '简体字'}, // Chinese Simplified
      {value: 'zh-CHT', text: '繁体字'}, // Chinese Traditional
      {value: 'hr', text: 'Hrvatska'}, // Croatian
      {value: 'cs', text: 'čeština'}, // Czech
      {value: 'da', text: 'danske'}, // Danish
      {value: 'nl', text: 'Nederlandse'}, // Dutch
      {value: 'en', text: 'English'}, // English
      {value: 'et', text: 'eesti'}, // Estonian
      {value: 'fi', text: 'suomi'}, // Finnish
      {value: 'fr', text: 'français'}, // French
      {value: 'de', text: 'Deutsch'}, // German
      {value: 'el', text: 'Ελληνική'}, // Greek
      {value: 'ht', text: 'kreyòl ayisyen'}, // Haitian Creole
      {value: 'he', text: 'עברית'}, // Hebrew
      {value: 'hi', text: 'हिन्दी'}, // Hindi
      {value: 'mww', text: 'Hmoob'}, // Hmong Daw
      {value: 'hu', text: 'magyar'}, // Hungarian
      {value: 'id', text: 'indonesia'}, // Indonesian
      {value: 'it', text: 'italiano'}, // Italian
      {value: 'ja', text: '日本語'}, // Japanese
      {value: 'tlh', text: 'tlhIngan Hol'}, // Klingon
      {value: 'tlh-Qaak', text: 'pIqaD'}, // Klingon (pIqaD)
      {value: 'ko', text: '한국어'}, // Korean
      {value: 'lv', text: 'Latvijā'}, // Latvian
      {value: 'lt', text: 'Lietuvos'}, // Lithuanian
      {value: 'ms', text: 'Melayu'}, // Malay
      {value: 'mt', text: 'Malti'}, // Maltese
      {value: 'no', text: 'norsk'}, // Norwegian
      {value: 'fa', text: 'فارسی'}, // Persian
      {value: 'pl', text: 'Polskie'}, // Polish
      {value: 'pt', text: 'português'}, // Portuguese
      {value: 'otq', text: 'Hñohño'}, // Querétaro Otomi
      {value: 'ro', text: 'român'}, // Romanian
      {value: 'ru', text: 'русский'}, // Russian
      {value: 'sr-Cyrl', text: 'Српски'}, // Serbian (Cyrillic)
      {value: 'sr-Latn', text: 'Srpski'}, // Serbian (Latin)
      {value: 'sk', text: 'slovenský'}, // Slovak
      {value: 'sl', text: 'slovenščina'}, // Slovenian
      {value: 'es', text: 'español'}, // Spanish
      {value: 'sv', text: 'svenska'}, // Swedish
      {value: 'th', text: 'ไทย'}, // Thai
      {value: 'tr', text: 'Türk'}, // Turkish
      {value: 'uk', text: 'Український'}, // Ukrainian
      {value: 'ur', text: 'اردو'}, // Urdu
      {value: 'vi', text: 'Tiếng Việt'}, // Vietnamese
      {value: 'cy', text: 'Cymraeg'}, // Welsh
      {value: 'yua', text: "Màaya t'àan"}, // Yucatec Maya
    ];
    var select_area = document.createElement('select');
    select_area.setAttribute('name', 'language');
    for (var i = 0; i < language_set.length; i++) {
      var option = document.createElement('option');
      option.setAttribute('value', language_set[i]['value']);
      option.innerHTML = language_set[i]['text'];
      select_area.appendChild(option);
    }
    $('input[name=email]').after(select_area);
    $('select[name=language] option[value='+language+']').attr('selected', true);
  }
  function renderMessage(message) {
    var date_html = '<span class="post-date">'+escapeHTML( new Date(message.timestamp).toLocaleString())+'</span>';
    var name_html = '<span class="post-name">' + escapeHTML(message.value.name+'@'+message.value.hash.substr(0,5)) + '</span>';
    var sent_id = message.id;
    var sent_message = escapeHTML(message.value.content);
    var sent_language = message.value.language;
    if (sent_language == language) {
      var foreign_html = '';
      var mother_html = '<p class="post-text mother">'+sent_message+'</p>';
    } else {
      var foreign_html = '<p class="post-text foreign">'+sent_message+'</p>';
      var mother_html = '<p class="post-text mother"></p>';
    }
    var delete_html = '<button class="delete-btn" id="delete'+sent_id+'">削除</button>';
    var new_html = date_html + name_html + foreign_html + mother_html + delete_html;
    new_html = sort == 'asc' ? '<hr>' + new_html : new_html + '<hr>';
    new_html = '<div id="'+sent_id+'" class="post">'+new_html+'</div>';
    var messages = $('#messages');
    if (last_message) {
      if (sort == 'asc') {
        $('#'+last_message).after(new_html);
        messages.scrollTop(messages.get(0).scrollHeight);
      } else {
        $('#'+last_message).before(new_html);
        messages.scrollTop(0);
      }
    } else {
      messages.append(new_html);
    }
    if (sent_language != language) {
      $('#'+sent_id+' .mother').text(translate(sent_id, sent_message, sent_language, language));
    }
    last_message = sent_id;
  }
  function post(dataStore) {
    var name = escapeHTML($("input[name=name]").val());
    var hash = escapeHTML(CryptoJS.MD5($("input[name=email]").val()));
    var content = escapeHTML($("#content").val());
    if (content && content !== "") {
      dataStore.push(
        {
          name: name,
          hash: hash,
          content: content,
          language: language
        },
        function (e) {}
      );
    }
    $("#content").val("");
  }
  function deleteElement(id) {
    $('#'+id).remove();
    if (sort == 'asc') {
      last_message = $('.post:last').attr('id');
    } else {
      last_message = $('.post:first').attr('id');
    }
  }
  function deleteMessage(dataStore, id) {
    var result;
    dataStore.remove(
      id,
      function(err, data){
        if (err != null) {
          console.log(err);
          result = false;
        }
        result = true;
      },
      function(err){
        console.log(err);
        result = false;
      }
    );
    if (result) deleteElement(id);
    return result;
  }
  function deleteAllMessages(dataStore) {
    while (last_message) {
      deleteMessage(dataStore, last_message);
    }
  }
  // テキスト翻訳
  function translate(id, text, from_lang, to_lang) {
    $.get(
      'get_translation.php?',
      {
        text: text,
        from: from_lang,
        to: to_lang
      },
      function(text){
        $('#'+id+' .mother').text(text);
        var messages = $('#messages');
        if (sort == 'asc') {
          messages.scrollTop(messages.get(0).scrollHeight);
        } else {
          messages.scrollTop(0);
        }
      }
    );
  }
  //インジェクション対策
  function escapeHTML(val) {
    return $('<div>').text(val).html();
  };
  </script>
</body>
</html>
