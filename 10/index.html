<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta property="og:title" content="LINE風チャットアプリ" />
  <meta property="og:type" content="chat" />
  <meta property="og:description" content="BaaS（Milkcocoa）で作られたリアルタイムチャット" />
  <title>LINE風チャットアプリ</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" />
  <link rel="stylesheet" href="style.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="http://cdn.mlkcca.com/v2.0.0/milkcocoa.js"></script>
  <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
</head>

<body>
  <header>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <span class="navbar-brand">LINE風チャットアプリ</span>
        </div>
        <a id="sort" class="btn btn-default navbar-btn header-btn pull-right">並べ替え</a>
      </div>
    </nav>
  </header>
  <main>
    <div class="container">
      <div id="messages" class="content">
      </div>
      <div id="postarea">
        <input type="text" name="name" placeholder="名前">
        <input type="email" name="email" placeholder="メールアドレス">
        <div class="postarea-text">
          <textarea name="" id="content" cols="30" rows="10" placeholder="Enterで投稿"></textarea>
        </div>
        <button id="post" class="postarea-button">送信</button>
        <button id="delete" class="postarea-button">全て削除</button>
      </div>
    </div>
  </main>
  <footer>
    <div class="container">
      <p class="footer">Powered by <a href="http://mlkcca.com/">Milkcocoa</a></p>
    </div>
  </footer>

  <script>
  var last_message;
  var sort = 'asc';
  $(function() {
    // ミルクココアインスタンスを作成
    var milkcocoa = new MilkCocoa("teaifc51u4b.mlkcca.com");
    // "message"データストアを作成
    var ds = milkcocoa.dataStore("message");
    // "message"データストアからメッセージを取ってくる
    ds.stream().sort("desc").next(function(err, datas) {
      datas.forEach(function(data) {
        renderMessage(data);
      });
    });
    // "message"データストアのプッシュイベントを監視
    ds.on("push", function(e) {
      renderMessage(e);
    });
    // "message"データストアにメッセージをプッシュする
    $('#post').on('click', function () {
      post(ds);
    })
    $('#content').on('keydown', function (e) {
      if (e.which == 13){
        post(ds);
        return false;
      }
    });
    // 後から追加した要素にもイベント適用させるため親要素に設定
    $('#messages').on('click', '.delete-btn', function(){
      var id = $(this).attr('id');
      id = id.substring('delete'.length, id.length);
      deleteMessage(ds, id);
    });
    $('#delete').on('click', function(){
      deleteAllMessages(ds);
    });
    // 並び順の変更
    $('#sort').on('click', function(){
      // 操作用のDocumentFragment作成
      var fragment = document.createDocumentFragment();
      var messages = document.getElementById('messages');
      var base = document.getElementById(last_message);
      var postarea = document.getElementById('postarea');
      // messagesをfragmentに移動
      fragment.appendChild(messages);

      sort = sort == 'asc' ? 'desc' : 'asc';
      if (sort == 'asc') {
        var next;
        // 並べ替え
        while (messages.lastChild.id != last_message) {
          next = base.nextSibling;
          messages.insertBefore(next, messages.firstChild);
        }
        // postarea.prepend(messages)
        postarea.parentNode.insertBefore(messages, postarea);
        $('#messages').scrollTop($('#messages').get(0).scrollHeight);
      } else {
        var prev;
        // 並べ替え
        while (messages.firstChild.id != last_message) {
          prev = base.previousSibling;
          messages.appendChild(prev);
        }
        // postarea.append(messages)
        postarea.parentNode.appendChild(messages);
      }
    });
  });
  function renderMessage(message) {
    var date_html = '<p class="post-date">'+escapeHTML( new Date(message.timestamp).toLocaleString())+'</p>';
    var name_html = '<p class="post-name">' + escapeHTML(message.value.name+'@'+message.value.hash.substr(0,5)) + '</p>';
    var message_html = '<p class="post-text">' + escapeHTML(message.value.content) + '</p>';
    var delete_html = '<button class="delete-btn" id="delete'+message.id+'">削除</button>';
    var new_html = '<div id="'+message.id+'" class="post">'+date_html + name_html + message_html + delete_html+'</div>';
    var messages = $('#messages');
    if (last_message) {
      if (sort == 'asc') {
        $('#'+last_message).after(new_html);
        messages.scrollTop(messages.get(0).scrollHeight);
      } else {
        $('#'+last_message).before(new_html);
        messages.scrollTop(0);
      }
    } else {
      messages.append(new_html);
    }
    last_message = message.id;
  }
  function post(dataStore) {
    var name = escapeHTML($("input[name=name]").val());
    var hash = escapeHTML(CryptoJS.MD5($("input[name=email]").val()));
    var content = escapeHTML($("#content").val());
    if (content && content !== "") {
      dataStore.push(
        {
          name: name,
          hash: hash,
          content: content
        },
        function (e) {}
      );
    }
    $("#content").val("");
  }
  function deleteMessage(dataStore, id) {
    var result;
    dataStore.remove(
      id,
      function(err, data){
        if (err != null) {
          console.log(err);
          result = false;
        }
        result = true;
      },
      function(err){
        console.log(err);
        result = false;
      }
    );
    if (result) {
      $('#'+id).remove();
      last_message = $(".post:first").attr('id');
    }
    return result;
  }
  function deleteAllMessages(dataStore) {
    while (last_message) {
      deleteMessage(dataStore, last_message);
    }
  }
  //インジェクション対策
  function escapeHTML(val) {
    return $('<div>').text(val).html();
  };
  </script>
</body>
</html>
